---
import { Image } from 'astro:assets'
import { cn } from '@/utils/cn'
import style01 from '@/assets/images/hg__sub-01.jpg'
import style02 from '@/assets/images/hg__sub-02.jpg'
import style03 from '@/assets/images/hg__sub-03.jpg'
import style04 from '@/assets/images/hg__sub-04.jpg'
import style05 from '@/assets/images/hg__sub-05.jpg'
import style06 from '@/assets/images/hg__sub-06.jpg'
import tape2 from '@/assets/images/decorations/tape-2.svg?url'
import tape6 from '@/assets/images/decorations/tape-6.svg?url'

const isDevelopment = import.meta.env.DEV

interface Props {
  class?: string
}

const { class: className = '' } = Astro.props
---

<section class={cn('mb-[7.4vw] md:mb-4 lg:pb-20 overflow-hidden', className)}>
  <div class="container mx-auto px-4">
    <!-- First 3 images -->
    <div
      class="mb-[16vw] grid grid-cols-1 gap-4 md:mb-20 md:grid-cols-3 md:gap-6 lg:gap-8"
    >
      <div
        class="gallery-item aspect-[3/4] overflow-hidden border border-navy-dark"
      >
        <Image
          src={style01}
          alt="THE NORTH FACE MATERNITY+ Style 1"
          widths={[390, 500, 600]}
          sizes="(max-width: 768px) 100vw, 33vw"
          loading="lazy"
          class="h-full w-full object-cover"
        />
      </div>
      <div class="gallery-item aspect-[3/4] border border-navy-dark relative">
        <Image
          src={style02}
          alt="THE NORTH FACE MATERNITY+ Style 2"
          widths={[390, 500, 600]}
          sizes="(max-width: 768px) 100vw, 33vw"
          loading="lazy"
          class="h-full w-full object-cover"
        />
        <!-- Tape decoration on image (desktop only) -->
        <img
          src={tape2}
          alt="Decorative tape"
          class="tape-image absolute -bottom-[1.8vw] left-1/2 translate-x-[-50%] w-[14.8vw] max-w-[213px] h-auto opacity-0 z-10 hidden md:block"
        />
      </div>
      <div class="gallery-item aspect-[3/4] border border-navy-dark relative">
        <Image
          src={style03}
          alt="THE NORTH FACE MATERNITY+ Style 3"
          widths={[390, 500, 600]}
          sizes="(max-width: 768px) 100vw, 33vw"
          loading="lazy"
          class="h-full w-full object-cover"
        />
        <!-- Tape decoration on image (mobile only) -->
        <img
          src={tape2}
          alt="Decorative tape"
          class="tape-image absolute -bottom-[5vw] left-1/2 translate-x-[-50%] w-[40vw] h-auto opacity-0 z-10 block md:hidden"
        />
      </div>
    </div>

    <!-- Title Section -->
    <div class="mb-[16vw] text-center md:mb-20">
      <h2
        class="font-display text-tape-navy-dark text-[5.87vw] font-medium md:text-4xl lg:text-5xl"
      >
        THE NORTH FACE <span class="text-brown">MATERNITY+</span>
      </h2>
    </div>

    <!-- Second 3 images -->
    <div
      class="mb-[16vw] grid grid-cols-1 gap-4 md:mb-24 md:grid-cols-3 md:gap-6 lg:gap-8"
    >
      <div class="gallery-item aspect-[3/4] border border-navy-dark relative">
        <Image
          src={style04}
          alt="THE NORTH FACE MATERNITY+ Style 4"
          widths={[390, 500, 600]}
          sizes="(max-width: 768px) 100vw, 33vw"
          loading="lazy"
          class="h-full w-full object-cover transition-transform"
        />
        <!-- Tape decoration on image (mobile only) -->
        <img
          src={tape6}
          alt="Decorative tape"
          class="tape-image-2 absolute -top-[5vw] left-1/2 translate-x-[-50%] w-[25vw] h-auto opacity-0 z-10 block md:hidden"
        />
      </div>
      <div class="gallery-item aspect-[3/4] border border-navy-dark relative">
        <Image
          src={style05}
          alt="THE NORTH FACE MATERNITY+ Style 5"
          widths={[390, 500, 600]}
          sizes="(max-width: 768px) 100vw, 33vw"
          loading="lazy"
          class="h-full w-full object-cover"
        />
        <!-- Tape decoration on image (desktop only) -->
        <img
          src={tape6}
          alt="Decorative tape"
          class="tape-image-2 absolute -top-[1.8vw] left-1/2 translate-x-[-50%] w-[9.4vw] h-auto opacity-0 z-10 hidden md:block"
        />
      </div>
      <div
        class="gallery-item aspect-[3/4] overflow-hidden border border-navy-dark"
      >
        <Image
          src={style06}
          alt="THE NORTH FACE MATERNITY+ Style 6"
          widths={[390, 500, 600]}
          sizes="(max-width: 768px) 100vw, 33vw"
          loading="lazy"
          class="h-full w-full object-cover"
        />
      </div>
    </div>

    <!-- Description Text -->
    <div class="mx-auto max-w-[85.33vw] md:max-w-max">
      <p
        class="text-tape-navy-dark text-center text-[4vw] md:text-[1.1vw] leading-loose font-sans-jp"
      >
        THE NORTH
        FACEã®MATERNITY+ã¯ã€æŒ‘æˆ¦ã‚„å¤‰åŒ–ã«ç«‹ã¡å‘ã‹ã†ã“ã¨ã‚’æ¥½ã—ã‚€ãŸã‚ã®ã‚¢ã‚¤ãƒ†ãƒ ãƒ©ã‚¤ãƒ³ã§ã™ã€‚<br
        />
        æ€§åˆ¥ã‚’å•ã‚ãšè‚²å…ã‚’ã™ã‚‹äººã®è² æ‹…ã‚’è»½æ¸›ã—ã€å­ã©ã‚‚ã®æˆé•·ã¨ã¨ã‚‚ã«å¤‰åŒ–ã‚’æ¥½ã—ã¿ã€<br
          class="hidden md:block"
        />
        é•·ãæ„›ç€ã‚’æŒã¤ã“ã¨ãŒã§ãã‚‹ã‚¦ã‚¨ã‚¢ã‚’å–ã‚Šæƒãˆã¦ã„ã¾ã™ã€‚<br />
        MATERNITY+ã¯ã€ã€Œå¦Šå¨ ãƒ»å‡ºç”£ã‚„å­è‚²ã¦ã‚’çµŒé¨“ã™ã‚‹å®¶æ—ã€ã®EXPLORATIONã‚’å¶ãˆã‚‹ã‚«ãƒ†ã‚´ãƒªãƒ¼ã¨ã—ã¦ã€<br
          class="hidden md:block"
        />
        è‚²å…ã‚’ã™ã‚‹ã²ã¨ã‚’æ€§åˆ¥ã‚’å•ã‚ãšã‚µãƒãƒ¼ãƒˆã—ã¾ã™ã€‚
      </p>
    </div>
  </div>
</section>

<script>
  import { gsap } from 'gsap'
  import { createManagedScrollTrigger } from '@/utils/gsap-manager'

  const isDevelopment = import.meta.env.DEV

  function initHighlightGalleryAnimations() {
    console.log('ğŸš€ HighlightGallery: Starting animations')

    // å…¨ã¦ã®ã‚®ãƒ£ãƒ©ãƒªãƒ¼ã‚¢ã‚¤ãƒ†ãƒ ã®åˆæœŸçŠ¶æ…‹ã‚’è¨­å®š
    const allGalleryItems = document.querySelectorAll('.gallery-item')
    allGalleryItems.forEach((item, index) => {
      // ã‚ˆã‚Šç´°ã‹ã„åˆæœŸä½ç½®ã®è¨­å®š
      let initialX = 0
      let initialY = 0
      let initialRotation = 0

      // æœ€åˆã®3æšã¨2ç•ªç›®ã®3æšã§åŒã˜ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’é©ç”¨
      const positionIndex = index % 3

      switch (positionIndex) {
        case 0: // å·¦ã®ç”»åƒï¼šå·¦ä¸‹ã‹ã‚‰ã€å·¦ã«å‚¾ã‘ã‚‹
          initialX = -600
          initialY = 300
          initialRotation = -15
          break
        case 1: // çœŸã‚“ä¸­ã®ç”»åƒï¼šçœŸã‚“ä¸­ã‚„ã‚„å³ä¸‹ã‹ã‚‰ã€å°‘ã—å³ã«å‚¾ã‘ã‚‹
          initialX = 200
          initialY = 250
          initialRotation = 5
          break
        case 2: // å³ã®ç”»åƒï¼šã•ã‚‰ã«å³å¯„ã‚Šã®å³ä¸‹ã‹ã‚‰ã€å³ã«å‚¾ã‘ã‚‹
          initialX = 700
          initialY = 350
          initialRotation = 20
          break
      }

      gsap.set(item, {
        x: initialX,
        y: initialY,
        rotation: initialRotation,
        opacity: 1,
        scale: 1,
      })
    })

    // æœ€åˆã®3ã¤ã®ç”»åƒç”¨ã®ScrollTrigger
    const firstGallerySection = document.querySelectorAll('.grid')[0]
    if (firstGallerySection) {
      createManagedScrollTrigger('highlight-gallery-first', {
        trigger: firstGallerySection,
        start: 'top 80%',
        end: 'bottom 20%',
        markers: isDevelopment,
        onEnter: () => {
          console.log('ğŸ“ First Gallery ScrollTrigger: onEnter')
          const firstThreeItems =
            firstGallerySection.querySelectorAll('.gallery-item')
          gsap.to(firstThreeItems, {
            x: 0,
            y: 0,
            rotation: 0,
            opacity: 1,
            scale: 1,
            duration: 0.8,
            stagger: 0.15,
            ease: 'steps(3, end)',
            onComplete: () => {
              // æœ€åˆã®ã‚®ãƒ£ãƒ©ãƒªãƒ¼ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†å¾Œã«ãƒ†ãƒ¼ãƒ—ã‚’è¡¨ç¤º
              const tapeImages =
                firstGallerySection.querySelectorAll('.tape-image')
              tapeImages.forEach((tape) => {
                // åˆæœŸçŠ¶æ…‹ã‚’è¨­å®š
                gsap.set(tape, {
                  rotation: -5,
                })
                // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
                gsap.to(tape, {
                  opacity: 1,
                  rotation: 0,
                  duration: 0.3,
                  ease: 'power2.out',
                })
              })
            },
          })
        },
        onLeave: () => console.log('ğŸ“ First Gallery ScrollTrigger: onLeave'),
        onEnterBack: () =>
          console.log('ğŸ“ First Gallery ScrollTrigger: onEnterBack'),
        onLeaveBack: () =>
          console.log('ğŸ“ First Gallery ScrollTrigger: onLeaveBack'),
      })
    }

    // ã‚¿ã‚¤ãƒˆãƒ«ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆScrollTriggerãªã—ï¼‰
    const testElement = document.querySelector('.text-center h2')
    if (testElement) {
      console.log('âœ… Test element found:', testElement)
      gsap.from(testElement, {
        duration: 2,
        y: 50,
        opacity: 0,
        ease: 'bounce.out',
        onComplete: () => {
          console.log('ğŸ‰ Basic animation completed!')
        },
      })
    }

    // 2ç•ªç›®ã®3ã¤ã®ç”»åƒç”¨ã®ScrollTrigger
    const secondGallerySection = document.querySelectorAll('.grid')[1]
    if (secondGallerySection) {
      createManagedScrollTrigger('highlight-gallery-second', {
        trigger: secondGallerySection,
        start: 'top 80%',
        end: 'bottom 20%',
        markers: isDevelopment,
        onEnter: () => {
          console.log('ğŸ“ Second Gallery ScrollTrigger: onEnter')
          const secondThreeItems =
            secondGallerySection.querySelectorAll('.gallery-item')
          gsap.to(secondThreeItems, {
            x: 0,
            y: 0,
            rotation: 0,
            opacity: 1,
            scale: 1,
            duration: 0.8,
            stagger: 0.15,
            ease: 'steps(3, end)',
            onComplete: () => {
              // 2ç•ªç›®ã®ã‚®ãƒ£ãƒ©ãƒªãƒ¼ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†å¾Œã«ãƒ†ãƒ¼ãƒ—ã‚’è¡¨ç¤º
              const tapeImages2 =
                secondGallerySection.querySelectorAll('.tape-image-2')
              tapeImages2.forEach((tape) => {
                // åˆæœŸçŠ¶æ…‹ã‚’è¨­å®š
                gsap.set(tape, {
                  rotation: -5,
                })
                // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
                gsap.to(tape, {
                  opacity: 1,
                  rotation: 0,
                  duration: 0.3,
                  ease: 'power2.out',
                })
              })
            },
          })
        },
        onLeave: () => console.log('ğŸ“ Second Gallery ScrollTrigger: onLeave'),
        onEnterBack: () =>
          console.log('ğŸ“ Second Gallery ScrollTrigger: onEnterBack'),
        onLeaveBack: () =>
          console.log('ğŸ“ Second Gallery ScrollTrigger: onLeaveBack'),
      })
    }

    // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’è¡¨ç¤º
    if (import.meta.env.DEV) {
      const memoryInfo = (performance as any).memory
      if (memoryInfo) {
        console.log('ğŸ’¾ Memory usage:', {
          used: Math.round(memoryInfo.usedJSHeapSize / 1024 / 1024) + ' MB',
          total: Math.round(memoryInfo.totalJSHeapSize / 1024 / 1024) + ' MB',
          limit: Math.round(memoryInfo.jsHeapSizeLimit / 1024 / 1024) + ' MB',
        })
      }
    }
  }

  // åˆæœŸåŒ–
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      console.log('ğŸ“„ DOM loaded, starting HighlightGallery animations...')
      setTimeout(initHighlightGalleryAnimations, 100)
    })
  } else {
    console.log('ğŸ“„ DOM ready, starting HighlightGallery animations...')
    setTimeout(initHighlightGalleryAnimations, 100)
  }

  // Astro page transitions
  document.addEventListener('astro:page-load', () => {
    console.log(
      'ğŸ”„ Astro page loaded, restarting HighlightGallery animations...'
    )
    setTimeout(initHighlightGalleryAnimations, 100)
  })
</script>
