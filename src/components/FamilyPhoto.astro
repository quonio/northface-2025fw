---
import { Image } from 'astro:assets'
import { cn } from '@/utils/cn'
import footerCoverImage01 from '@/assets/images/img-footer-cover-01.jpg'
import footerCoverImage02 from '@/assets/images/img-footer-cover-02.jpg'

interface Props {
  class?: string
}

const { class: className } = Astro.props
---

<section class={cn('family-photo-section relative w-full', className)}>
  <div class="relative h-[100vh] w-full overflow-hidden">
    <Image
      src={footerCoverImage01}
      alt="THE NORTH FACE MATERNITY+ Family"
      widths={[390, 768, 1280, 1920, 2560]}
      sizes="100vw"
      loading="lazy"
      class="family-photo-image family-photo-1 absolute inset-0 h-full w-full object-cover object-center"
      data-image="1"
    />
    <Image
      src={footerCoverImage02}
      alt="THE NORTH FACE MATERNITY+ Family"
      widths={[390, 768, 1280, 1920, 2560]}
      sizes="100vw"
      loading="lazy"
      class="family-photo-image family-photo-2 absolute inset-0 h-full w-full object-cover object-center"
      data-image="2"
    />
  </div>
</section>

<script>
  import { gsap } from 'gsap'
  import { createManagedScrollTrigger } from '@/utils/gsap-manager'

  function initFamilyPhotoAnimation() {
    console.log('ğŸ¯ FamilyPhoto: Initializing animation')

    const section = document.querySelector('.family-photo-section')
    const image1 = document.querySelector('.family-photo-1') as HTMLElement
    const image2 = document.querySelector('.family-photo-2') as HTMLElement

    if (!section || !image1 || !image2) {
      console.warn('âš ï¸ FamilyPhoto: Required elements not found')
      return
    }

    console.log('âœ… FamilyPhoto: Elements found', { section, image1, image2 })

    // åˆæœŸçŠ¶æ…‹ã‚’è¨­å®š
    // image2ã‚’ä¸‹ã‹ã‚‰ä¸Šã«ã‚¹ãƒ©ã‚¤ãƒ‰ã•ã›ã‚‹ãŸã‚ã€clipPathã‚’ä½¿ç”¨
    gsap.set(image1, {
      opacity: 1,
      zIndex: 1,
      scale: 1,
      transformOrigin: 'center center',
    })
    gsap.set(image2, {
      opacity: 1,
      zIndex: 2,
      scale: 1.05, // åˆæœŸçŠ¶æ…‹ã§å°‘ã—å¤§ãã‚
      transformOrigin: 'center center',
      clipPath: 'polygon(0 100%, 100% 100%, 100% 100%, 0 100%)', // åˆæœŸçŠ¶æ…‹ï¼šå®Œå…¨ã«éš ã‚Œã¦ã„ã‚‹
    })

    // ç®¡ç†ã•ã‚ŒãŸScrollTriggerã‚’ä½œæˆï¼ˆãƒ”ãƒ³ç•™ã‚åŠ¹æœä»˜ãï¼‰
    const scrollTrigger = createManagedScrollTrigger('family-photo', {
      trigger: section,
      start: 'top top', // ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ä¸Šéƒ¨ãŒç”»é¢ä¸Šéƒ¨ã«åˆ°é”ã—ãŸã‚‰ãƒ”ãƒ³ç•™ã‚é–‹å§‹
      end: '+=200%', // ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®é«˜ã•ã®2å€åˆ†ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ãŸã‚‰çµ‚äº†
      pin: true, // ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å›ºå®š
      pinSpacing: true, // ãƒ”ãƒ³ç•™ã‚æ™‚ã®ã‚¹ãƒšãƒ¼ã‚¹ã‚’ç¢ºä¿
      scrub: 1,
      markers: false, // æœ¬ç•ªç’°å¢ƒã§ã¯ false
      onUpdate: (self) => {
        const progress = self.progress
        console.log('ğŸ“Š FamilyPhoto Progress:', progress.toFixed(2))

        // ä¸‹ã‹ã‚‰ä¸Šã«ã‚¹ãƒ©ã‚¤ãƒ‰ã™ã‚‹ã‚ˆã†ã«clipPathã‚’ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
        const revealHeight = progress * 100
        gsap.to(image2, {
          clipPath: `polygon(0 ${100 - revealHeight}%, 100% ${100 - revealHeight}%, 100% 100%, 0 100%)`,
          duration: 0,
          immediateRender: false,
        })

        // å›ºå®šä¸­ã®ã‚ãšã‹ãªã‚ºãƒ¼ãƒ åŠ¹æœï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
        const scale = 1 + progress * 0.05 // æœ€å¤§5%æ‹¡å¤§
        gsap.to(image1, {
          scale: scale,
          duration: 0,
          immediateRender: false,
        })

        gsap.to(image2, {
          scale: 1 + (1 - progress) * 0.05, // image2ã¯é€†æ–¹å‘ã«ã‚¹ã‚±ãƒ¼ãƒ«
          duration: 0,
          immediateRender: false,
        })
      },
    })

    if (scrollTrigger) {
      console.log('ğŸš€ FamilyPhoto: ScrollTrigger created successfully')
    }
  }

  // åˆæœŸåŒ–
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initFamilyPhotoAnimation)
  } else {
    initFamilyPhotoAnimation()
  }

  // Astro page transitionså¯¾å¿œ
  document.addEventListener('astro:page-load', initFamilyPhotoAnimation)
</script>
