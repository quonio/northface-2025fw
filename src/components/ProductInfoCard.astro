---
import headlineFrame from '../assets/images/decorations/headline-frame.svg'
import { cn } from '@/utils/cn'
import BuyLink from './BuyLink.astro'

interface Props {
  headline?: string
  modelNumber?: string
  title: string
  copy?: string
  description?: string
  colors?: string[]
  sizes?: string[]
  price?: string
  link?: string
  totalPages?: number
  carouselId?: string
  size?: 'sm' | 'md' | 'lg'
}

const {
  headline,
  modelNumber,
  title,
  copy,
  description,
  colors = [],
  sizes = [],
  price,
  link,
  totalPages = 0,
  carouselId = '',
  size = 'lg',
} = Astro.props

// ®記号を上付きのspanタグに変換する関数
const formatRegisteredMark = (text: string | undefined) => {
  if (!text) return ''
  return text.replace(/®/g, '<span class="text-[0.9em] align-top">®</span>')
}

// サイズに応じたクラスを定義
const sizeClasses = {
  sm: {
    container: 'p-4',
    headline: 'text-[8px] lg:text-[9px]',
    modelNumber: 'text-[10px]',
    title: 'text-lg md:text-xl',
    price: 'text-sm',
    copy: 'text-sm',
    description: 'text-xs',
    buyLink: 'right-4 bottom-[calc(1rem+3.61vw+1rem)]',
    pager: '-mx-4 -mb-4',
    pagerButton: 'text-[2.78vw]',
  },
  md: {
    container: 'p-6',
    headline: 'text-[9px] lg:text-[10px]',
    modelNumber: 'text-xs',
    title: 'text-xl md:text-2xl',
    price: 'text-base',
    copy: 'text-base',
    description: 'text-sm',
    buyLink: 'right-6 bottom-[calc(1.5rem+3.5rem+1rem)]',
    pager: '-mx-6 -mb-6',
    pagerButton: 'text-3xl',
  },
  lg: {
    container: 'p-[6.4vw] md:p-[2.24vw]',
    headline: 'text-[2.24vw] lg:text-[10px]',
    modelNumber: 'text-[3.2vw] md:text-xs',
    title: 'text-[7.47vw] md:text-[2.2vw]',
    price: 'text-[3.2vw] md:text-[0.972vw]',
    copy: 'text-[4.8vw] md:text-[1.25vw]',
    description: 'text-[4vw] md:text-[1.1vw] leading-[1.75]',
    buyLink:
      'static ml-auto mb-[5.2vw] md:absolute md:right-[2.24vw] md:bottom-[calc(2.24vw+4.5vw+1rem)] md:ml-0 md:mb-0',
    pager: '-mx-[2.24vw] -mb-[2.24vw]',
    pagerButton: 'hidden md:block md:text-[4.5vw]',
  },
}

const currentSize = sizeClasses[size]
---

<article
  class={cn(
    'bg-cream-dark h-full flex flex-col justify-between min-h-full border border-light-navy relative',
    currentSize.container
  )}
>
  <div>
    {
      headline && (
        <div class="inline-block mb-6">
          <span
            class={cn(
              'inline-block bg-no-repeat bg-center p-[0.5em] font-light uppercase tracking-[0.1em] text-brown whitespace-nowrap min-w-[62px] min-h-[20px] leading-none text-center',
              currentSize.headline
            )}
            style={`background-image: url(${headlineFrame.src}); background-size: 100% 100%;`}
          >
            {headline}
          </span>
        </div>
      )
    }

    {
      modelNumber && (
        <p
          class={cn(
            'text-tape-navy-dark font-light mb-2',
            currentSize.modelNumber
          )}
        >
          {modelNumber}
        </p>
      )
    }

    <h3
      class={cn(
        'font-sans font-medium text-tape-navy-dark mb-2 tracking-tight',
        currentSize.title
      )}
    >
      {title}
    </h3>

    {
      price && (
        <p class={cn('font-medium text-brown mb-6', currentSize.price)}>
          {price}
        </p>
      )
    }

    {
      copy && (
        <p class={cn('font-bold text-tape-navy-dark mb-4', currentSize.copy)}>
          {copy}
        </p>
      )
    }

    {
      description && (
        <p
          class={cn(
            'text-tape-navy-dark mb-4 leading-[1.75] font-normal font-sans-jp',
            currentSize.description
          )}
          set:html={formatRegisteredMark(description)}
        />
      )
    }
  </div>

  {
    link && size !== 'sm' && (
      <div class={cn(currentSize.buyLink)}>
        <BuyLink href={link} size={size} />
      </div>
    )
  }

  {
    link && size === 'sm' && (
      <div
        class={cn(
          'mt-0 pr-4 flex justify-end',
          totalPages > 0 && carouselId && 'mb-4'
        )}
      >
        <BuyLink href={link} size="sm" />
      </div>
    )
  }

  <!-- Pagination -->
  {
    totalPages > 0 && carouselId && (
      <div
        class={cn('pager flex gap-0 mt-auto', currentSize.pager)}
        style={
          size === 'lg'
            ? 'width: calc(100% + 4.48vw); max-height: 6vw;'
            : size === 'sm'
              ? 'width: calc(3.61vw * 4); max-height: 3.61vw;'
              : 'width: calc(100% + 3rem);'
        }
        data-carousel-pagination={carouselId}
      >
        {Array.from({ length: totalPages }, (_, i) => (
          <button
            class={cn(
              'pagination-btn relative z-[1] bg-transparent border-t border-r border-light-navy-2 font-thin text-light-navy-2 no-underline flex items-center justify-center leading-none',
              size === 'sm' ? 'w-[3.61vw] h-[3.61vw]' : 'flex-1 aspect-square',
              'hover:bg-light-navy-2/10 transition-colors',
              size !== 'sm' && 'last:border-r-0',
              '[&.is-active]:bg-light-navy-2 [&.is-active]:text-white [&.is-active]:border-light-navy-2 [&.is-active]:z-[2]',
              currentSize.pagerButton
            )}
            data-page={i}
            aria-label={`Go to page ${i + 1}`}
          >
            {i + 1}
          </button>
        ))}
      </div>
    )
  }
</article>
